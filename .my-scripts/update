#!/bin/bash

is_checking_for_antivirus=1
command_to_disable_antivirus="sudo /opt/sophos-av/bin/savdctl disable"
command_to_enable_antivirus="sudo /opt/sophos-av/bin/savdctl enable"
command_to_check_if_antivirus_is_active="sudo /opt/sophos-av/bin/savdstatus"
status_is_inactive=4
status_is_active=0

if [[ $is_checking_for_antivirus -eq 1 ]]; then
  echo " " ;
  echo "==========================================="
  echo "Temporarily Disabling Antivirus"
  ${command_to_disable_antivirus}
  sleep 5
  echo "Checking if antivirus is disabled..."
  ${command_to_check_if_antivirus_is_active}
  if [[ $? -eq $status_is_inactive ]]; then
    echo "Antivirus is Successfully Disabled, continuing with update."
  else
    echo "FAILED to disable antivirus, exiting without updating"
    exit 2
  fi
fi

echo " " ;
echo "==========================================="
echo "Ready to Update..."

# $OS is an environment variable that is set in my bashrc
echo "OS is $OS"
if [[ $OS  == "Debian" ]]; then
  echo "Using apt-get"
  echo ""
  echo "Updating Repos"
  echo "=============="
  sudo apt update || sudo apt-get update
  echo "Updating System"
  echo "==============="
  sudo apt -y dist-upgrade || sudo apt-get -y dist-upgrade
  echo "Autoremoving Obsolete Packages"
  echo "=============================="
  sudo apt -y autoremove || sudo apt-get -y autoremove
  echo "Performing autoclean"
  echo "===================="
  sudo apt -y autoclean || sudo apt-get -y autoclean
elif [[ $OS  == "Manjaro" ||
        $OS  == "Arch"
     ]]; then
  echo "Using pacman"
  echo ""
  echo "Updating Repos and System"
  echo "========================="
  sudo pacman -Syyu --noconfirm
  echo "Autoremoving obsolete packages and cleaning"
  echo "==========================================="
  sudo pacman -Rns --noconfirm $(pacman -Qqtd)
else
  echo "Could not determine what package manager to use."
  exit 1
fi

echo " "
echo "Update Complete!"
echo "==========================================="

if [[ $is_checking_for_antivirus -eq 1 ]]; then
  echo " " ;
  echo "==========================================="
  echo "Enabling Antivirus"
  ${command_to_enable_antivirus}
  sleep 5
  echo "Checking if antivirus is enabled..."
  ${command_to_check_if_antivirus_is_active}
  if [[ $? -eq $status_is_active ]]; then
    echo "Antivirus is Successfully Enabled"
  else
    echo "FAILED to enable antivirus"
    echo "********** MANUALLY REENABLE YOUR ANTIVIRUS! **********"
    echo "Enable your AV  : \"${command_to_enable_antivirus}\""
    echo "Check AV status : \"${command_to_check_if_antivirus_is_active}\""
    exit 3
  fi
fi

exit 0
